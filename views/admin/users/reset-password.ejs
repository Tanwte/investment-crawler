<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Investment Crawler Admin</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .form-container { max-width: 600px; margin: 20px auto; padding: 0 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
        .btn-primary { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn-secondary { background: #6c757d; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; display: inline-block; margin-right: 10px; }
        .alert-danger { background: #f8d7da; color: #721c24; padding: 12px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; padding: 12px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #ffeaa7; }
        .user-info { background: #e7f3ff; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .password-requirements { background: #e7f3ff; padding: 15px; border-radius: 4px; margin-top: 10px; font-size: 14px; }
        .password-requirements ul { margin: 10px 0 0 20px; }
        .password-strength { margin-top: 10px; }
        .password-strength-bar { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .password-strength-fill { height: 100%; transition: all 0.3s ease; }
    </style>
</head>
<body>
    <header>
        <h1>Reset Password: <%= editUser.username %></h1>
        <nav>
            <a href="/admin/users/<%= editUser.id %>/edit">‚Üê Back to Edit User</a>
            <a href="/admin/users">User Management</a>
        </nav>
    </header>

    <div class="form-container">
        <% if (error) { %>
            <div class="alert-danger">
                <strong>Error:</strong> <%= error %>
            </div>
        <% } %>

        <div class="alert-warning">
            <strong>‚ö†Ô∏è Security Notice:</strong><br>
            You are about to reset the password for user "<%= editUser.username %>". 
            The user will need to use the new password to log in. Consider informing them of the change.
        </div>

        <div class="user-info">
            <h3>User Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <strong>Username:</strong> <%= editUser.username %><br>
                    <strong>Full Name:</strong> <%= editUser.full_name || 'N/A' %><br>
                    <strong>Email:</strong> <%= editUser.email || 'N/A' %>
                </div>
                <div>
                    <strong>Role:</strong> <%= editUser.role.toUpperCase() %><br>
                    <strong>Last Login:</strong> 
                    <%= editUser.last_login ? new Date(editUser.last_login).toLocaleString() : 'Never' %><br>
                    <strong>Failed Attempts:</strong> <%= editUser.failed_login_attempts || 0 %>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Set New Password</h2>
            <form method="POST" action="/admin/users/<%= editUser.id %>/reset-password" id="passwordForm">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" required 
                           placeholder="Enter new password" minlength="6">
                    <div class="password-strength">
                        <div class="password-strength-bar">
                            <div class="password-strength-fill" id="strengthBar"></div>
                        </div>
                        <small id="strengthText">Password strength will appear here</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" required 
                           placeholder="Confirm new password" minlength="6">
                    <small id="matchText" style="color: #666;"></small>
                </div>

                <div class="password-requirements">
                    <strong>Password Requirements:</strong>
                    <ul>
                        <li>Minimum 6 characters long</li>
                        <li>Should contain uppercase and lowercase letters</li>
                        <li>Should include at least one number</li>
                        <li>Consider using special characters for extra security</li>
                        <li>Avoid common words or personal information</li>
                    </ul>
                </div>

                <div style="margin-top: 30px;">
                    <a href="/admin/users/<%= editUser.id %>/edit" class="btn-secondary">Cancel</a>
                    <button type="submit" class="btn-primary" id="submitBtn" disabled>Reset Password</button>
                </div>
            </form>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 4px;">
            <h3>Password Reset Effects</h3>
            <p>When you reset this user's password:</p>
            <ul>
                <li>‚úÖ Failed login attempts will be reset to 0</li>
                <li>‚úÖ Account will be unlocked if it was locked</li>
                <li>‚úÖ User will be able to log in immediately with the new password</li>
                <li>‚úÖ All existing sessions for this user will remain active</li>
                <li>üìù This action will be logged in the audit trail</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('new_password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            const matchText = document.getElementById('matchText');
            const submitBtn = document.getElementById('submitBtn');

            function checkPasswordStrength(password) {
                let score = 0;
                let feedback = [];

                if (password.length >= 6) score += 1;
                else feedback.push('At least 6 characters');

                if (password.match(/[a-z]/)) score += 1;
                else feedback.push('Lowercase letter');

                if (password.match(/[A-Z]/)) score += 1;
                else feedback.push('Uppercase letter');

                if (password.match(/[0-9]/)) score += 1;
                else feedback.push('Number');

                if (password.match(/[^a-zA-Z0-9]/)) score += 1;
                else feedback.push('Special character');

                const strength = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'][score];
                const colors = ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#28a745'];
                const widths = ['20%', '40%', '60%', '80%', '100%'];

                strengthBar.style.backgroundColor = colors[score];
                strengthBar.style.width = widths[score];
                strengthText.textContent = `Strength: ${strength}${feedback.length ? ' (Missing: ' + feedback.join(', ') + ')' : ''}`;
                strengthText.style.color = colors[score];

                return score >= 2; // Require at least "Fair" strength
            }

            function checkPasswordMatch() {
                const password = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (confirmPassword === '') {
                    matchText.textContent = '';
                    return false;
                }

                const match = password === confirmPassword;
                matchText.textContent = match ? '‚úÖ Passwords match' : '‚ùå Passwords do not match';
                matchText.style.color = match ? '#28a745' : '#dc3545';
                return match;
            }

            function updateSubmitButton() {
                const strongEnough = checkPasswordStrength(newPasswordInput.value);
                const passwordsMatch = checkPasswordMatch();
                const hasMinLength = newPasswordInput.value.length >= 6;

                submitBtn.disabled = !(strongEnough && passwordsMatch && hasMinLength);
            }

            newPasswordInput.addEventListener('input', updateSubmitButton);
            confirmPasswordInput.addEventListener('input', updateSubmitButton);

            // Form submission
            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                if (!checkPasswordStrength(newPasswordInput.value) || !checkPasswordMatch()) {
                    e.preventDefault();
                    alert('Please ensure the password meets requirements and both passwords match.');
                }
            });
        });
    </script>
</body>
</html>